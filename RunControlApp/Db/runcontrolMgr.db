## name of set, stored in a PV as need to used as INLINK 
record(stringin, "$(P)CS:RC:_SETNAME")
{
	field(VAL, "RC")
}	

## This is useful if you are moving between SECI and IBEX
## It forces a re-issue of the current IBEX view of run control
## which can then override e.g. a previous WAITING state set by SECI
## it is also now used by $(P)CS:RC:_CHECK
record(bo, "$(P)CS:RC:SYNC:SP")
{
    field(DESC, "Sync Run Control status")
	field(FLNK, "$(P)CS:RC:_CALC2.PROC")
}

record(aSub, "$(P)CS:RC:_OUT:CNT")
{
    field(SNAM, "getSetItemCount")
	field(INPA, "$(P)CS:RC:_SETNAME")
	field(FTA, "STRING")
	field(OUTA, "$(P)CS:RC:OUT:CNT PP")
	field(FTVA, "ULONG")
	field(FLNK, "$(P)CS:RC:_CALC.PROC")
} 

record(longin, "$(P)CS:RC:OUT:CNT")
{
    field(VAL, "0")
	info(archive, "VAL")
}

record(bi, "$(P)CS:RC:INRANGE")
{
    field(VAL, "1")
    field(ZNAM, "NO")
    field(ONAM, "YES")
	info(archive, "VAL")
}

# use a calcout record to avoid writing to OUT:LIST too often 
# and triggering unnecessary monitors  
record(calcout, "$(P)CS:RC:_CALC")
{
    field(INPA, "$(P)CS:RC:OUT:CNT")
	field(CALC, "A")
	field(OOPT, "On Change")
	field(DOPT, "Use CALC")
	field(OUT, "$(P)CS:RC:_CALC2.PROC PP")
}	

record(calcout, "$(P)CS:RC:_CALC2")
{
    field(INPA, "$(P)CS:RC:OUT:CNT")
	field(CALC, "A > 0 ? 0 : 1")
	field(OOPT, "Every Time")
	field(DOPT, "Use CALC")
	field(OUT, "$(P)CS:RC:INRANGE PP")
	field(FLNK, "$(P)CS:RC:_CALC3.PROC")
}	

record(calcout, "$(P)CS:RC:_CALC3")
{
    field(INPA, "$(P)CS:RC:OUT:CNT")
	field(CALC, "A > 0 ? 5 : 3")
	field(OOPT, "Every Time")
	field(DOPT, "Use CALC")
	field(OUT, "$(P)CS:RC:_SEQ.SELN")
	field(FLNK, "$(P)CS:RC:_SEQ.PROC")
}	

record(seq, "$(P)CS:RC:_SEQ")
{
    field(SELM, "Mask")
	field(DOL1, 1)
	field(DOL2, 1)
	field(DOL3, 1)
	field(LNK1, "$(P)CS:RC:_OUT:LIST.PROC PP")
	field(LNK2, "$(P)DAE:ENDSEWAIT PP")
	field(LNK3, "$(P)DAE:STARTSEWAIT PP")
}

record(aSub, "$(P)CS:RC:_OUT:LIST")
{
    field(SNAM, "getSetItems")
	field(INPA, "$(P)CS:RC:_SETNAME")
	field(FTA, "STRING")
	field(OUTA, "$(P)CS:RC:OUT:LIST PP")
	field(FTVA, "CHAR")
	field(NOVA, "4096")
	field(FTVB, "ULONG")
} 

record(waveform, "$(P)CS:RC:OUT:LIST")
{
	field(NELM, "4096")
	field(FTVL, "CHAR")
}

## perform a periodic check that a run control message to DAE did not get lost 
## RUNNING is run state number 2 and WAITING is 4 (see isisdae.db)
## we archive VAL so we could see how often it is needed
record(calcout, "$(P)CS:RC:_CHECK")
{
    field(INPA, "$(P)DAE:RUNSTATE NPP")
	field(INPB, "$(P)CS:RC:OUT:CNT NPP")
	field(CALC, "((A=4)&&(B=0))||((A=2)&&(B>0))")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use CALC")
	field(OUT, "$(P)CS:RC:SYNC:SP PP")
	field(SCAN, "5 second")
	info(archive, "VAL")
}
