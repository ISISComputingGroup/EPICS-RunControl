record(ao, "$(PV):$(MODE):HIGH")
{
    field(DESC, "$(MODE) Control high limit")
	field(PREC, "2")
    info(autosaveFields, "VAL")
	info(archive, "VAL")
}

record(ao, "$(PV):$(MODE):LOW")
{
    field(DESC, "$(MODE) control low limit")
	field(PREC, "2")
    info(autosaveFields, "VAL")
	info(archive, "VAL")
}

record(ao, "$(PV):$(MODE):OUT:DELAY")
{
    field(DESC, "$(MODE) out action delay")
	field(PREC, "2")
	field(VAL, "2")
    info(autosaveFields, "VAL")
}

record(ao, "$(PV):$(MODE):IN:DELAY")
{
    field(DESC, "$(MODE) in action delay")
	field(PREC, "2")
	field(VAL, "2")
    info(autosaveFields, "VAL")
}


## show number of seconds out of range
record(ai, "$(PV):$(MODE):OUT:TIME")
{
    field(VAL, "0")
    field(DESC, "Time out of range")
	field(EGU, "s")
	field(PREC, "1")
}

## show number of seconds in range
record(ai, "$(PV):$(MODE):IN:TIME")
{
    field(VAL, "0")
    field(DESC, "Time in range")
	field(EGU, "s")
	field(PREC, "1")
}

record(bo, "$(PV):$(MODE):ENABLE")
{
    field(DESC, "$(MODE) control enable")
	field(ZNAM, "NO")
	field(ONAM, "YES")
	field(VAL, 0)
	field(FLNK, "$(PV):$(MODE):SOI")
    info(autosaveFields, "VAL")
	info(archive, "VAL")
}

record(bi, "$(PV):$(MODE):INRANGE")
{
    field(DESC, "$(MODE) control in range")
	field(ZNAM, "NO")
	field(ONAM, "YES")
	field(VAL, 1)
	info(archive, "VAL")
}

record(bo, "$(PV):$(MODE):SOI")
{
    field(DESC, "$(MODE) suspend on invalid")
	field(ZNAM, "NO")
	field(ONAM, "YES")
	field(VAL, "0")
    info(autosaveFields, "VAL")
	info(archive, "VAL")
}

## main processing loop
## only scan if control enabled
record(bo, "$(PV):$(MODE):_CALCSCAN")
{
    field(SCAN, "1 second")
	field(SDIS, "$(PV):$(MODE):ENABLE")
	field(DISV, "0")
    field(FLNK, "$(PV):$(MODE):OUT:TIME:_CALC")
}

## calculate number of seconds out of range
record(calcout, "$(PV):$(MODE):OUT:TIME:_CALC")
{
    field(INPA, "$(PV):$(MODE):INRANGE NPP")
    field(INPB, "$(PV):$(MODE):OUT:TIME NPP")
	field(CALC, "A = 0 ? B + 1 : 0")
	field(OOPT, "On Change")
    field(OUT, "$(PV):$(MODE):OUT:TIME PP")
	field(FLNK, "$(PV):$(MODE):IN:TIME:_CALC")
}

## calculate number of seconds in range
record(calcout, "$(PV):$(MODE):IN:TIME:_CALC")
{
    field(INPA, "$(PV):$(MODE):INRANGE NPP")
    field(INPB, "$(PV):$(MODE):IN:TIME NPP")
	field(CALC, "A = 0 ? 0 : B + 1")
	field(OOPT, "On Change")
    field(OUT, "$(PV):$(MODE):IN:TIME PP")
	field(FLNK, "$(PV):$(MODE):_SEVR_CHECK")
}

record(calcout, "$(PV):$(MODE):_SEVR_CHECK")
{
    field(INPA, "$(PV).SEVR")
    field(CALC, "A")
    field(OCAL, "A")
    field(IVOA, "Set output to IVOV")
    field(IVOV, "3")  # If INPA becomes disconnected treat like an INVALID alarm
    field(OOPT, "Every Time")
	field(DOPT, "Use OCAL")
    field(OUT, "$(PV):$(MODE):_CALC.E NPP")
    field(FLNK, "$(PV):$(MODE):_VAL_CHECK")
}

record(calcout, "$(PV):$(MODE):_VAL_CHECK")
{
    field(INPA, "$(PV)")
    field(CALC, "A")
    field(OCAL, "A")
    field(OOPT, "Every Time")
	field(DOPT, "Use OCAL")
    field(OUT, "$(PV):$(MODE):_CALC.A NPP")
    field(FLNK, "$(PV):$(MODE):_CALC")
}

record(calcout, "$(PV):$(MODE):_CALC")
{
    field(INPA, "")  # Written from $(PV):$(MODE):_VAL_CHECK
    field(INPB, "$(PV):$(MODE):LOW")
    field(INPC, "$(PV):$(MODE):HIGH")
    field(INPD, "$(PV):$(MODE):ENABLE")
    field(INPE, "")  # Written from $(PV):$(MODE):_SEVR_CHECK
    field(INPF, "$(PV):$(MODE):SOI")
	field(CALC, "((D=0)||(A>=B&&A<=C&&(E<3||F=0)))?12:3")
	field(OOPT, "Every Time")
	field(DOPT, "Use CALC")
	field(OUT, "$(PV):$(MODE):_SEQ.SELN")
    field(IVOA, "Continue normally")
	field(FLNK, "$(PV):$(MODE):_SEQ.PROC")
}

record(sseq, "$(PV):$(MODE):_SEQ")
{
    field(SELM, "Mask")
	field(STR1, "NO")
	field(STR2, "$(PV)")
	field(STR3, "YES")
	field(STR4, "$(PV)")
	field(LNK1, "$(PV):$(MODE):INRANGE PP")
	field(LNK2, "$(PV):$(MODE):_OUT PP")
	field(LNK3, "$(PV):$(MODE):INRANGE PP")
	field(LNK4, "$(PV):$(MODE):_IN PP")
}

record(waveform, "$(PV):$(MODE):_OUT")
{
	field(NELM, "256")
	field(FTVL, "CHAR")
	field(FLNK, "$(PV):$(MODE):_OUT:CALC.PROC")
}	

record(calcout, "$(PV):$(MODE):_OUT:CALC")
{
    field(INPA, "$(PV):$(MODE):OUT:TIME NPP")     
	field(INPB, "$(PV):$(MODE):OUT:DELAY NPP")
	field(CALC, "A>B?1:0")
	field(OOPT, "When Non-zero")
	field(OCAL, "1")
	field(DOPT, "Use OCAL")
	field(OUT, "$(PV):$(MODE):_OUT:DO.PROC PP")
}	

record(aSub, "$(PV):$(MODE):_OUT:DO")
{
    field(SNAM, "addToSet")
	field(INPA, "$(P)CS:$(MODE):_SETNAME")
	field(FTA, "STRING")
	field(INPB, "$(PV):$(MODE):_OUT")
	field(FTB, "CHAR")
	field(NOB, "256")
	field(INPC, "$(PV):$(MODE):_OUT.NELM") # NORD not set by CA
	field(FTC, "ULONG")
}

record(waveform, "$(PV):$(MODE):_IN")
{
	field(NELM, "256")
	field(FTVL, "CHAR")
	field(FLNK, "$(PV):$(MODE):_IN:CALC.PROC")
}	

record(calcout, "$(PV):$(MODE):_IN:CALC")
{
    field(INPA, "$(PV):$(MODE):IN:TIME NPP")     
	field(INPB, "$(PV):$(MODE):IN:DELAY NPP")
	field(CALC, "A>B?1:0")
	field(OOPT, "When Non-zero")
	field(OCAL, "1")
	field(DOPT, "Use OCAL")
	field(OUT, "$(PV):$(MODE):_IN:DO.PROC PP")
}	

record(aSub, "$(PV):$(MODE):_IN:DO")
{
    field(SNAM, "removeFromSet")
	field(INPA, "$(P)CS:$(MODE):_SETNAME")
	field(FTA, "STRING")
	field(INPB, "$(PV):$(MODE):_IN")
	field(FTB, "CHAR")
	field(NOB, "256")
	field(INPC, "$(PV):$(MODE):_IN.NELM") # NORD not set by CA
	field(FTC, "ULONG")
}

